---

language: "es"
title: "Configurando Twitter y AWS ‚Äì Bot con AWS Lambda: P1"
tags: 
  - python
  - github
  - aws
slug: "lambda-tweet-parte-1-github-aws-twitter"
publishDate: "2022-02-02T10:00:01"
description: Vamos a hablar sobre algunos detalles ‚Äúadministrativos‚Äù de conseguir y almacenar los secretos necesarios para que esta peque√±a aplicaci√≥n funcione
ogImage: "https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/cycles-part-1_BOlOK42Bl.jpg"
---

Esta serie de posts consta de 8 entregas, siendo esta la primera en donde vamos a hablar sobre algunos detalles ‚Äúadministrativos‚Äù de conseguir y almacenar los secretos necesarios para que esta peque√±a aplicaci√≥n funcione. Los siguientes posts en la serie abordan a su vez un aspecto muy espec√≠fico del problema, puedes encontrarlos aqu√≠:

 - Configurando Twitter y AWS - [Parte 1](/lambda-tweet-parte-1-github-aws-twitter)
 - Programando la lambda con Python - [Parte 2](/lambda-tweet-parte-2-python)
 - Mejorando el mapa con GeoPandas - [Parte 3](/lambda-tweet-parte-3-mapas-geopandas)
 - Creando la lambda en un contenedor - [Parte 4](/lambda-tweet-parte-4-contenedor-lambda)
 - Infraestructura con Terraform - [Parte 5](/lambda-tweet-parte-5-terraform)
 - Automatizaci√≥n con GitHub Actions - [Parte 6](/lambda-tweet-parte-6-github-actions)
 - Agregando pruebas con Pytest - [Parte 7](/lambda-tweet-parte-7-add-testing)
 - Optimizando Docker - [Parte 8](/lambda-tweet-parte-8-aligerando-docker)

---

En Londres hay un sistema de renta de bicicletas el cual suelo usar frecuentemente, hay cerca de 700 estaciones en toda la red y desde siempre me intrig√≥ conocer c√≥mo es que estas fluyen en la ciudad.

Resulta que la autoridad a cargo del sistema tiene una API que permite ser consultada para saber cu√°ntas bicicletas hay por estaci√≥n al momento de realizar esta consulta; y resulta que esta es justo la informaci√≥n necesaria para crear una visualizaci√≥n que me permitiera observar el flujo a lo largo del d√≠a.

As√≠ que con eso en mente me decid√≠ crear un bot que consultara el estado de la red, y as√≠ es como se ve el resultado final, al que llegaremos cuando esta serie de post est√© terminada.

![https://twitter.com/CyclesLondon/status/1488784529766682625](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/Screenshot_2022-02-02_at_22.08.13_Gyqq-QAyJ.png?tr=w-500)

S√≠, es un tuit, y es que lo que vamos a hacer es una aplicaci√≥n que tuitee el estado de la red de bicicletas cada determinado tiempo. En esta serie te voy a hablar de: Python con pandas, geopandas, twython, AWS Lambda, Docker...

# Secretos

Antes de continuar es necesario realizar unas cuantas tareas administrativas. A recordar que lo que vamos a hacer es:

1. Hacer el despliegue de la infraestructura necesaria en AWS de forma programatica ‚Äì lo cual significa que necesitaremos llaves de acceso
2. Tuitear de forma program√°tica ‚Äì lo cual significa que necesitaremos llaves de acceso

# AWS

 > üòÖ No estoy a√∫n muy seguro de los costos de AWS para este ejercicio, estoy un 80% seguro que los recursos que usaremos caen dentro de el [AWS Free Tier](https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&all-free-tier.sort-order=asc&awsf.Free%20Tier%20Types=*all&awsf.Free%20Tier%20Categories=*all), pero por si las dudas, checa por tu cuenta.

Las lambdas se ejecutan en AWS, por lo cual requerir√°s contar con una cuenta de AWS. Hay muchos tutoriales en la web sobre c√≥mo crear una as√≠ que no me voy a detener mucho en esto.

El siguiente paso es crear un usuario y darle permisos espec√≠ficos para las tareas que vamos a realizar. Dentro de tu consola, busca el servicio IAM:

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/iam-service_fI9EuukZ5.png](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/iam-service_fI9EuukZ5.png)

Ah√≠ navega a *Access Management > Users* y da click en el bot√≥n *Add users:*

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/add-user_FIEBF60rO.png](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/add-user_FIEBF60rO.png)

Selecciona un nombre para este usuario y algo muy importante, selecciona el checkbox que dice *Access key - Programmatic access* puesto que vamos a acceder de forma program√°tica con este usuario ‚Äì despu√©s, da click en el bot√≥n de *Next: Permissions* para asignarle los permisos requeridos:

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/create-user_fdIHXYTSK.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643452127899](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/create-user_fdIHXYTSK.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643452127899)

En la pantalla de permisos, selecciona primero la opci√≥n de *Attach existing policies directly*, lo cual te dejar√° seleccionar permisos pre-establecidos, de ellos asegurate de seleccionar los siguientes: *SecretsManagerReadWrite*, *IAMFullAccess*, *AmazonEC2ContainerRegistryFullAccess*, *CloudWatchEventsFullAccess*, *AWSLambda_FullAccess* y *AmazonS3FullAccess*, como se muestra en la imagen:

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/attach-existing-policies_Pgo79RhJe.png](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/attach-existing-policies_Pgo79RhJe.png)

Para terminar, y una vez que hayas elegido todos los permisos que te mencion√©, da click en el bot√≥n *Next: Tags*, luego en el bot√≥n *Next: Review* y finaliza dando click en *Create user*. 

Para terminar, se te va a presentar una pantalla de √©xito, en donde hay unos cuantos valores que m√°s vale mantener secretos, **muy, muy secretos**. Yo los redact√© en la imagen a continuaci√≥n:

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/access-credentials_UqXADfo3Z.png](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/access-credentials_UqXADfo3Z.png)

Reitero, manten esos secretos a salvo pero a la mano, los vamos a usar m√°s adelante; y ya que estamos en eso, nosotros nos vamos a estar refiriendo a estos de la siguiente manera: *Access key ID* ‚Üí `AWS_ACCESS_KEY_ID` y *Secret access key* ‚Üí `AWS_SECRET_ACCESS_KEY`.

# Twitter

 > üòÖ Te recomiendo que te crees una cuenta de tuiter excusiva para esta tarea, a menos que quieras que los tuits salgan de tu cuenta ‚Äúpersonal‚Äù ‚Äì cualquier cuenta que uses debe estar verificada mediante tu tel√©fono celular.

Como vamos a tuitear, necesitamos habilitar nuestra cuenta de desarrollador en [developer.twitter.com](https://developer.twitter.com/), si es que a√∫n no la tienes, en la esquina superior derecha te aparecer√° un bot√≥n de *Sign Up*:

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/sign-up_baa3xthaZ.png](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/sign-up_baa3xthaZ.png)

Tendr√°s que llenar unos cuantos formularios, coloca tu informaci√≥n (aseg√∫rate de elegir *Making a bot* en la pregunta de *What's your use case?*), as√≠ es como yo llen√© el m√≠o:

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/twitter-form_G0tjxZ6zHqa.png](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/twitter-form_G0tjxZ6zHqa.png)

Despu√©s de aceptar los t√©rminos y condiciones y verificar tu cuenta de correo electr√≥nico tu cuenta como *developer* estar√° activa, ahora puedes regresar a [developer.twitter.com](https://developer.twitter.com/) para por fin, crear tu app y obtener otros cuantos secretos.

En el portal de *developers*, navega a *Projects & Apps* y *scrollea* hasta que aparezca el bot√≥n de *+ Add App*, da click en √©l.

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/add-app_GpJyadpfC.png](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/add-app_GpJyadpfC.png)

La siguiente pantall√° nos pedir√° un nombre para nuestra app y en cuanto elijamos uno, nos entregar√° una parte de las credenciales que necesitamos para comenzar a tuitear:

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/app-keys_sIO3QWVVY.png](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/app-keys_sIO3QWVVY.png)

De las llaves presentadas, **guarda muy bien la de API Key y API Key Secret**, las vamos a usar para tuitear desde la Lambda. Ah, y de ahora en adelante vamos a conocer a *API Key* como `TWITTER_API_KEY` y a *API Key Secret* como `TWITTER_API_SECRET`. Para finalizar, en esa pantalla da click en el bot√≥n *App Settings.*

Dentro de *App Settings*, haz *scroll* hasta que llegues a la secci√≥n de *User Authentication Settings*, y ah√≠ da click en *Set Up.*

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/setup-auth-settings_GPZOXrKXx.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643458519793](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/setup-auth-settings_GPZOXrKXx.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643458519793)

Dentro de esta nueva pantalla selecciona solamente *OAuth 1.0a*, y **en *App Permissions* elige *Read and Write:***

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/Screenshot_2022-01-29_at_12.13.27_Q3RdG2yin.png](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/Screenshot_2022-01-29_at_12.13.27_Q3RdG2yin.png)

Lo que pongas en el resto de los campos no es tan importante, para las direcciones web que son requeridas puedes poner la direcci√≥n de tu blog o simplemente https://www.google.com, no importa este valor.

Ahora regresaremos a la pantalla principal de nuestra app, listos para conseguir el resto de los secretos que necesitamos. Para esto navega a la secci√≥n *Keys and tokens*, hacia el fondo de la p√°gina hasta encontrar *Authentication tokens* ‚Äì si te das cuenta, nos indica que el token fue creado con permisos de ‚Äúsolo lectura‚Äù, para cambiar esto, elige *Regenerate* y te dar√° nuevos tokens que, s√≠, vas a tener que proteger y tener a la mano:

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/get-new-tokens_wJmCKerJ8.png](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/get-new-tokens_wJmCKerJ8.png)

De ahora en adelante vamos a conocer a *Access Token* como `TWITTER_ACCESS_TOKEN` y a *Access Token Secret* como `TWITTER_ACCESS_TOKEN_SECRET`.

Y si te das cuenta, el token ahora dice que fue creado con permisos de lectura y escritura:

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/read-write_quTnnmuZSKE.png](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/read-write_quTnnmuZSKE.png)

Hasta ahora ya deber√≠as tener 6 secretos, 2 de AWS: `AWS_ACCESS_KEY_ID` y `AWS_SECRET_ACCESS_KEY`; y 4 de Twitter: `TWITTER_API_KEY`, `TWITTER_API_SECRET`, `TWITTER_ACCESS_TOKEN` y `TWITTER_ACCESS_TOKEN_SECRET`. Casi terminamos, falta solo una tarea m√°s.

# De vuelta a AWS

## Secretos

Como no queremos andar por ah√≠ publicando nuestros secretos en p√∫blico, vamos guardarlos en AWS para que despu√©s podamos acceder a ellos durante el despliegue de nuestra lambda sin preocuparnos de tenerlos que escribirlos manualmente.

Desde la consola busca el servicio de *Secrets Manager*:

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/secrets-manager_bhLEqjsomrk.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643466700574](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/secrets-manager_bhLEqjsomrk.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643466700574)

Deber√≠as encontrar un bot√≥n para agregar un nuevo secreto *Store a new secret*, da click en √©l, lo cual te llevar√° a una pantalla en donde deber√°s agregar los secretos de Twitter, lo primero es selccionar *Other type of secret*, luego en *Key/value pairs* agrega los secretos, solo de Twitter, recuerda que son 4,usa *+ Add row*, para agregar m√°s campos ‚Äì deja el resto de opciones con su valor por default y da click en *Next*:

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/add-secret_FTpOPzXP2.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643468105533](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/add-secret_FTpOPzXP2.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643468105533)

La siguiente pantalla te preguntar√° sobre el nombre de tu secreto, elige algo descriptivo, puedes usar `/` para separar distintos *namespaces* con el fin de hacer m√°s descriptivo el nombre:

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/secret-name_Z5HZ5xL_C.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643468898109](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/secret-name_Z5HZ5xL_C.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643468898109)

Si quieres agrega una descripci√≥n, deja todos los campos restantes en blanco o con su valor default y da click en *Next* hasta que el bot√≥n se convierta en *Store*, el cual tambi√©n debes *clickear*. 

Al terminar volver√°s a la pantalla de inicio del *Secrets Manager* y listo, el secreto ha sido guardado.

## Una cubeta para Terraform

M√°s adelante vamos a usar una herramienta llamada *Terraform* para gestionar la infraestructura necesaria para desplegar nuestra lambda en AWS. Como parte de su funcionamiento, esta herramienta genera un archivo en donde se almacena el estado de la infraestructura.

Si trabajas en equipo, o vas a usar una herramienta de CI/CD (¬°como nosotros!) lo recomendable es que este archivo est√© disponible para que quien vaya a a√±adir o modificar la infraestructura pueda acceder a √©l. Una de las formas sugeridas (y seguras) de compartirlo es a trav√©s de una cubeta de *S3* en *AWS* ‚Äìo similar si est√°s trabajando con otro provedor‚Äì.

Vamos a crear esta cubeta ya que estamos en la consola de AWS, busca S3 dentro de los servicios disponibles:

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/s3_IeOgcIO3T.png](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/s3_IeOgcIO3T.png)

Al darle click, ver√°s un bot√≥n titulado *Create bucket*:

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/create-bucket_lHGpvOgwJup.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643739021955](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/create-bucket_lHGpvOgwJup.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643739021955)

Se te presentar√° una pantalla solicit√°ndote el nombre de la cubeta y la regi√≥n en la que esta debe ser creada, toda mi infraestructura existir√° en *eu-west-1*, la tuya podr√° ser diferente, solamente aseg√∫rate de que usas la misma consistentemente a lo largo de este tutorial.

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/bucket-name_KjNP6WrIQ.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643739022089](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/bucket-name_KjNP6WrIQ.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643739022089)

Deja todas las dem√°s opciones con sus valores por defecto y termina la creaci√≥n de la cubeta. 

# GitHub

Estamos haciendo todo esto porque vamos a automatizar el despliegue de nuestra app desde GitHub, es por eso que deber√≠as crear un nuevo repositorio en el cual iremos poniendo nuestro c√≥digo ‚Äì y como ver√°s, tambi√©n nuestros secretos.

No explicar√© c√≥mo crear un nuevo repo, pero s√≠ la parte de los secretos. Primero ve a *Settings* en el repositorio reci√©n creado, luego en la barra izquierda selecciona *Secrets* y luego *Actions*. Por √∫ltimo da click en *New repository secret*.

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/add-secret-screen_QmpIxD-qM.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643788934148](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/add-secret-screen_QmpIxD-qM.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643788934148)

Ac√° la cosa es simple, debes elegir un nombre para el secreto y asignarle un valor. Recuerda, debemos guardar ambos secretos de AWS: `AWS_ACCESS_KEY_ID` y `AWS_SECRET_ACCESS_KEY`, uno a la vez. ¬°Aseg√∫rate de que no introduzcas espacios innecesarios en los valores!

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/add-secret_-p9g8DY-R6.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643788933742](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/add-secret_-p9g8DY-R6.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643788933742)

Al finalizar, deber√≠as tener una pantalla muy similar a esta:

![https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/action-secrets_DXxrDG4C8Wz.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643788934008](https://ik.imagekit.io/thatcsharpguy/posts/python-lambdas/action-secrets_DXxrDG4C8Wz.png?ik-sdk-version=javascript-1.4.3&updatedAt=1643788934008)

Y listo, ahora si ya est√° casi todo lo ‚Äúadministrativo‚Äù.

# Conclusi√≥n

No hubo nada de c√≥digo en esta entrada, m√°s bien un mont√≥n de configuraci√≥n y tareas administrativas necesarias para permitirnos ejecutar despliegue continuo y para poder tuitear desde una Lambda de AWS.

Recuerda que me puedes encontrar en Twitter [en @feregri_no](https://twitter.com/feregri_no) para preguntarme sobre este post ‚Äì si es que algo no queda tan claro o encontraste un *typo*. El c√≥digo final de esta serie [est√° en GitHub](https://github.com/fferegrino/tweeting-cycles-lambda) y la cuenta que tuitea el estado de la red de bicicletas es [@CyclesLondon](https://twitter.com/CyclesLondon) 
