---
layout: "@/layouts/BlogPost"
lannguage: "es"
title: "Publicando aplicaciones hechas con Xamarin desde GitHub Actions"
original_url: "https://thatcsharpguy.com/post/publicando-aplicaciones-hechas-con-xamarin-desde-github-actions"
author: "Antonio Feregrino"
lang: "es"
tags: 
  - xamarin
  - xamairn-forms
  - github
  - github-actions
publishDate: "2020-07-25T12:00:00"
description: Aplica la integraci칩n continua a tus aplicaciones hechas con Xamarin y publica desde GitHub Actions.
ogImage: "https://i.imgur.com/zGD1Caj.png"
---

La combinaci칩n de integraci칩n y despliegue continuo es fant치stica, no hay nada mejor que la sensaci칩n de saber que tus cambios estar치n en producci칩n tan r치pido como sea posible; adem치s de evitarte el tedio de tener que hacer el *deployment* manualmente, que en el caso de Xamarin.Forms es un doble dolor: publicar en la App Store y Google Play. 

En este peque침o tutorial les voy a mostrar c칩mo es que podemos usar las herramientas a nuestro alcance para lograr simplificar el proceso de publicaci칩n de apps usando GitHub Actions; ahora, mientras que aqu칤 hablo sobre Actions en espec칤fico, esto no implica que puedas llevar las mismas ideas a tu herramienta favorita de *CI*.

### Requerimientos  

Vamos a usar *GPG* para proteger los archivos necesarios para publicar, si no tienes `gpg` instalada en tu Mac, la puedes instalar con `
brew install gpg`. Idealmente cuentas con una Mac, sin embargo, no te preocupes si ese no es el caso, puedes continuar leyendo el tutorial y aplicar las ideas en tu computadora Windows.

Una contrase침a (vamos a llamarla `DECRYPT_KEY`) para encriptar archivos mediante *gpg*, te recomiendo que sea generada autom치ticamente. Gen칠rala y tenla a la mano porque la vamos a utilizar unas cuantas veces en este post.

Idealmente ya cuentas con conocimiento de c칩mo publicar tus apps en las tiendas.

# iOS

## Obteniendo un certificado de publicaci칩n para iOS  
Te recomiendo generar un certificado de publicaci칩n para cada app que desarrolles, aunque, este certificado lo puedes compartir entre varias, puesto que este certificado te identifica a ti como quien publica la app. En este caso, ser치 el servidor de GitHub el que publique y al que t칰 le estar치s dando permiso de autenticarse como tu.

 - Para generar un certificado nuevo, visita [https://developer.apple.com/account/resources/certificates/list](https://developer.apple.com/account/resources/certificates/list), elige "Crear un nuevo certificado" y selecciona "Apple Distribution":

![elige "Crear un nuevo certificado" y selecciona "Apple Distribution"](https://imgur.com/b6T6YYw.png)

 - Una vez creado, descarga el certificado e inst치lalo en tu computadora. Para instalarlo simplemente da doble click en el archivo que acabas de descargar.

![descarga el certificado e inst치lalo en tu computadora](https://i.imgur.com/XXThK37.png)

 - El siguiente paso es crear y descargar un perfil de publicaci칩n para tu app:

![El siguiente paso es crear y descargar un perfil de publicaci칩n para tu app](https://i.imgur.com/6CodfmN.png)

 - Elige "Distribution" y "App Store":

![Elige "Distribution" y "App Store"](https://i.imgur.com/TbrqVrY.png)

 - Elige despu칠s el identificador de tu aplicaci칩n:

![Elige despu칠s el identificador de tu aplicaci칩n](https://i.imgur.com/0eCLTi0.png) 

 - Aseg칰rate tambi칠n que elijas el certificado adecuado, justamente el que creamos en el paso anterior.

![Aseg칰rate tambi칠n que elijas el certificado adecuado](https://i.imgur.com/pIKkXbl.png)

 - Establece un nombre descriptivo, y genera el perfil de publicaci칩n.

![Establece un nombre descriptivo, y genera el perfil de publicaci칩n](https://i.imgur.com/peJlpOZ.png)

 - El siguiente paso es descargar y abrir el perfil de publicaci칩n, si Xcode no est치 abierto, el abrir el perfilde publicaci칩n lo abrir치. Una vez hecho esto, podemos configurar nuestra app para usarlos al momento de crear el archivo que vamos a publicar en la App Store.

## Configura tu app para usar los certificados  
 El siguiente paso es configurar tu aplicaci칩n de Xamarin.iOS (o tu aplicaci칩n de iOS normal), la opci칩n a elegir en Xamarin es "iOS Bundle Signing", aseg칰rate de que en la Configuraci칩n est칠 seleccionada la opci칩n `Release` y de que como plataforma est칠 elegida `iPhone`. Luego entonces selecciona el certificado y el perfil de aprovisionamiento que acabamos de crear.

![Configura tu app para usar los certificados](https://i.imgur.com/zJGWRBu.png)


## Colocando los certificados en GitHub  

 > 游뚿丘멆잺 춰Mucho cuidado! 춰aseg칰rate de no subir ninguno de los siguientes archivos a menos de que est칠n encriptados! 丘멆잺游뚿

### Exportando el certificado  

![Exportando el certificado](https://i.imgur.com/G0pF2C0.png)  

![Exportando el certificado](https://i.imgur.com/hByhz7g.png)  

Guarda el archivo con el nombre `Certificates.p12` dentro de la carpeta `secrets`.

![Guarda el archivo con el nombre Certificates.p12 dentro de la carpeta secrets](https://i.imgur.com/5gT22K6.png)

### Exportando los perfiles de publicaci칩n  
Lo primero es descubrir cu치l es el perfil de publicaci칩n que corresponde al que acabamos de descargar, para hacerlo, lista los perfiles con el siguiente comando:

```shell
ls -lah ~/Library/MobileDevice/Provisioning\ Profiles/
```

En este caso, el m치s reciente es el que corresponde al perfil de publicaci칩n de nuestra app, tiene el identificador `f3b9e904-6d99-409a-91f4-440c5b79565d`:

![En este caso, el m치s reciente es el que corresponde al perfil de publicaci칩n de nuestra app](https://i.imgur.com/9cEkq9v.png)  

El siguiente paso es copiar el perfil a la carpeta `secrets`. 

```shell
cp ~/Library/MobileDevice/Provisioning\ Profiles/f3b9e904-6d99-409a-91f4-440c5b79565d.mobileprovision secrets
```  

Toma nota de este identificador porque lo ver치s en muchos lados, el m칤o es `f3b9e904-6d99-409a-91f4-440c5b79565d` pero el tuyo sera diferente.

### Encriptando nuestros secretos  

Como lo mencion칠 al inicio de esta secci칩n, no podemos subir nuestros secretos (l칠ase el certificado y el perfil de publicaci칩n) as칤 como as칤 a GitHub, antes hay que protegerlos mediante la encriptaci칩n. Usaremos *gpg* y la contrase침a que creaste al inicio de este post.

```shell
gpg --symmetric --cipher-algo AES256 Certificates.p12
gpg --symmetric --cipher-algo AES256 f3b9e904-6d99-409a-91f4-440c5b79565d.mobileprovision
```

Despu칠s de esto, deber치s tener un par de archivos con el mismo nombre que los anteriores, pero con `.gpg` como extensi칩n:

```shell
Certificates.p12.gpg
f3b9e904-6d99-409a-91f4-440c5b79565d.mobileprovision.gpg
```

Solo para asegurarnos de que no vamos a publicar nuestros secretos al descubierto, los eliminamos:

```shell
rm Certificates.p12
rm f3b9e904-6d99-409a-91f4-440c5b79565d.mobileprovision
```

### Desencriptando el certificado en GitHub  
Una vez que nuestros archivos est치n en GitHub encriptados, debemos hacer posible desencriptarlos dentro de la ejecuci칩n de nuestro flujo de trabajo:  

 - Desencriptar los secretos usando el password almacenado en "DECRYPT_KEY"
 
```shell
gpg --quiet --batch --yes --decrypt --passphrase="$DECRYPT_KEY" --output ./secrets/f3b9e904-6d99-409a-91f4-440c5b79565d.mobileprovision ./secrets/f3b9e904-6d99-409a-91f4-440c5b79565d.mobileprovision.gpg
gpg --quiet --batch --yes --decrypt --passphrase="$DECRYPT_KEY" --output ./secrets/Certificates.p12 ./secrets/Certificates.p12.gpg
```
 - Crea la carpeta "Provisioning Profiles" en la computadora que est치 ejecutando las acciones de GitHub

```shell
mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
```

 - Copia el perfil de publicaci칩n a la carpeta reci칠n creada

```shell
cp ./secrets/f3b9e904-6d99-409a-91f4-440c5b79565d.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/f3b9e904-6d99-409a-91f4-440c5b79565d.mobileprovision
```

 - Crea un Keychain e importa el archivo Certificates.p12

```shell
security create-keychain -p "" build.keychain
security import ./secrets/Certificates.p12 -t agg -k ~/Library/Keychains/build.keychain -P "" -A
```

 - Establece el Keychain recien creado como default

```shell
security list-keychains -s ~/Library/Keychains/build.keychain
security default-keychain -s ~/Library/Keychains/build.keychain
security unlock-keychain -p "" ~/Library/Keychains/build.keychain
security set-key-partition-list -S apple-tool:,apple: -s -k "" ~/Library/Keychains/build.keychain
```

Todas las instrucciones anteriores debemos colocarlas en un archivo llamado `decrypt_secrets.sh` dentro de nuestra carpeta `secrets`, no te olvides de darle permisos de ejecuci칩n a este archivo mediante el siguiente comando:

```
chmod +x secrets/decrypt_secrets.sh
```  

## Compilando la app  
El siguiente paso en el flujo de trabajo es compilar la aplicaci칩n de tal modo que nos genere un archivo `.ipa` que podemos cargar directamente en la App Store, para esta tarea usaremos `msbuild`:  

```shell
nuget restore
msbuild \
  /p:Configuration=Release \
  /p:Platform=iPhone \
  /p:BuildIpa=true \
  /target:Build \
  PinCountdown.iOS/PinCountdown.iOS.csproj
```
Primero estamos restaurando todos los paquetes de NuGet, luego le indicamos que queremos compilar la aplicaci칩n usando la configuraci칩n `Release`, adem치s de que queremos que compile el archivo Ipa, y lo apuntamos al proyecto de iOS, que en mi caso est치 en `PinCountdown.iOS/PinCountdown.iOS.csproj`.

## Publicando en iTunes Connect  
El siguiente paso es publicar nuestro archivo `.ipa` en la App Store, para ello vamos a usar una herramienta que nos ofrece Xcode:  

```shell
xcrun altool --upload-app -t ios \
  -f PinCountdown.iOS/bin/iPhone/Release/PinCountdown.iOS.ipa \
  -u "${{ secrets.APPLEID_USERNAME }}" -p "${{ secrets.APPLEID_PASSWORD }}"
```  

Le estamos indicando a `xcrun` que nuestro archivo a subir est치 en al carpeta `PinCountdown.iOS/bin/iPhone/Release/`, adem치s de indicarle nuestras credenciales mediante secretos de GitHub, de los cuales hablaremos a continuaci칩n.

## Configurando GitHub  
Ahora, es necesario configurar nuestro repositorio con los secretos que vamos a usar para publicar nuestra app, para esto nos dirigimos a *Configuraci칩n > Secretos*

![Ahora, es necesario configurar nuestro repositorio con los secretos que vamos a usar para publicar nuestra app, para esto nos dirigimos a *Configuraci칩n > Secretos*](https://imgur.com/AP4VRrl.png)
Hay que a침adir tres nuevos secretos:  

 - `DECRYPT_KEY`: la contrase침a que usamos para encriptar los secretos
 - `APPLEID_USERNAME`: la cuenta de correo electr칩nico para acceder a iTunes Connect (para mayor seguridad, puedes crear una cuenta de correo espec칤fica para cada app)
 - `APPLEID_PASSWORD`: la contrase침a de la cuenta de iTunes Connect

# Android  

## Generando una `keystore` 
Vamos a generar un primer APK de nuestra app porque hay que subir primero na versi칩n manualmente (gracias Google), y de paso generamos un nuevo `keystore`.  Ojo que si ya publicaste una versi칩n de tu app usando otro `keystore`, ese es el que debes usar en lugar de generar uno nuevo.

 - Da click derecho en tu aplicaci칩n de Xamarin.Android y selecciona *"Archivar para publicaci칩n"*

![Da click derecho en tu aplicaci칩n de Xamarin.Android y selecciona *"Archivar para publicaci칩n"*](https://imgur.com/3egO8Q0.png)
 - Una vez terminada la compilaci칩n, da click derecho en el archivo reci칠n creado y selecciona *Firmar y distribu칤r*

![Una vez terminada la compilaci칩n, da click derecho en el archivo reci칠n creado y selecciona *Firmar y distribu칤r*](https://i.imgur.com/2hk1gX0.png)  

 - Selecciona el m칠todo de distribuci칩n *Ad Hoc*

![Selecciona el m칠todo de distribuci칩n *Ad Hoc*](https://i.imgur.com/rsVmRGw.png)  

 - Para crear una nueva *keystore*, selecciona *Crear una nueva llave*  

![Para crear una nueva *keystore*, selecciona *Crear una nueva llave*](https://i.imgur.com/P7g1BFz.png)  

 - En la siguiente ventana, selecciona un alias para tu *keystore*, establece un alias y una contrase침a, recuerda esta contrase침a, vamos a llamarla `KEYSTORE_PASS`

![En la siguiente ventana, selecciona un alias para tu *keystore*, establece un alias y una contrase침a](https://i.imgur.com/jwfIDZ3.png)  

 - Una vez creada, da click derecho para ver mayor informaci칩n sobre la llave que acabas de crear

![Una vez creada, da click derecho para ver mayor informaci칩n sobre la llave que acabas de crear](https://i.imgur.com/9254zZ4.png)  

 - Toma nota de la direcci칩n de tu *keystore*, la vamos a usar m치s adelante
 
![Toma nota de la direcci칩n de tu *keystore*, la vamos a usar m치s adelante](https://i.imgur.com/oKRhomm.png)  

 - Por 칰ltimo, continua con la publicaci칩n natural de tu app y c치rgala a la Google Play Store, recuerda que es necesario publicar la primera versi칩n manualmente.

## Cargando la *keystore* a GitHub  
Al igual que como hicimos con nuestros certificados de iOS, es necesario que carguemos nuestra *keystore* a GitHub, desde luego, debemos protegerla primero usando *gpg*.

Recuerdas la direcci칩n de la *keystore* que obtuvimos en el paso anterior? es hora de usarla para copiar la *keystore* en nuestra carpeta `secrets`:

```shell
cp /Users/antonioferegrino/Library/Developer/Xamarin/Keystore/PinCountdown/PinCountdown.keystore ./secrets/PinCountdown.keystore
```

Encriptamos, usando nuevamente nuestra contrase침a `DECRYPT_KEY` que generamos al incio:

```shell
cd secrets
gpg --symmetric --cipher-algo AES256 PinCountdown.keystore
```

Por 칰ltimo borramos el archivo `PinCountdown.keystore`, dejando solamente `PinCountdown.keystore.gpg` (adem치s de los otros `.gpg` correspondientes a iOS):

```shell
rm PinCountdown.keystore
```

No te olvides de colocar tus cambios en GitHub, para que ahora tu *keystore* est칠 protegida dentro del control de versiones.

## Desencriptando la *keystore* en GitHub  

Coloca las siguientes l칤neas dentro del archivo `secrets/decrypt_secrets.sh` :

```shell
gpg --quiet --batch --yes --decrypt --passphrase="$DECRYPT_KEY" --output ./secrets/PinCountdown.keystore ./secrets/PinCountdown.keystore.gpg
```

## Compilando la app  

```shell
nuget restore
msbuild \
  /p:Configuration=Release \
  /p:Platform=AnyCPU \
  /target:SignAndroidPackage \
  /p:AndroidSigningKeyAlias="PinCountdown" \
  /p:AndroidSigningKeyPass='${{ secrets.KEYSTORE_PASS }}' \
  /p:AndroidSigningStorePass='${{ secrets.KEYSTORE_PASS }}'  \
  /p:AndroidKeyStore="true" \
  /p:AndroidSigningKeyStore="./secrets/PinCountdown.keystore" \
  PinCountdown.Android/PinCountdown.Android.csproj
```  

Con ese comando tan largo de *msbuild* le estamos indicando que queremos generar un paquete de Android en la configuraci칩n `Release`, junto con todos los detalles correspondientes a la *keystore* que vamos a usar para ese prop칩sito.

## Cargando nuestro archivo a la Google Play Store  
Para este paso no es necesario hacer nada *"manualmente"*, solamente tenemos que usar la acci칩n [r0adkll/upload-google-play@v1](https://github.com/r0adkll/upload-google-play) (que tendr치s que configurar separadamente). El archivo de nuestro `apk` firmado est치 siempre dentro de la carpeta `bin/Release` del proyecto, en el caso de la app que he usado para este proyecto, el archivo est치 en: `PinCountdown.Android/bin/Release/com.messier16.pincountdown-Signed.apk`.

## Configurando GitHub  
En este 칰ltimo paso resta agregar un nuevo secreto, en esta ocasi칩n el secreto `KEYSTORE_PASS`, que corresponde a la clave que establecimos en un paso anterior. Y listo, eso es todo para la configuraci칩n.

# Configurando GitHub actions

A continuaci칩n les muestro el archivo que pone todas las piezas en su lugar, esta es la configuraci칩n del *pipeline* de GitHub actions, en teor칤a, todos los pasos los describimos previamente y aqu칤 solo resta usarlos.

```yaml
name: Build the app
on: push
jobs:
  build:
    runs-on: macOS-latest
    steps:

      - name: Checkout repo
        uses: actions/checkout@v1

      - name: Decrypt Secrets
        run: ./secrets/decrypt_secrets.sh
        env:
          DECRYPT_KEY: ${{ secrets.DECRYPT_KEY }}

      - name: iOS Build
        run: |
          nuget restore
          msbuild \
            /p:Configuration=Release \
            /p:Platform=iPhone \
            /p:BuildIpa=true \
            /target:Build \
            PinCountdown.iOS/PinCountdown.iOS.csproj

      - name: Android Build
        run: |
          nuget restore
          msbuild \
            /p:Configuration=Release \
            /p:Platform=AnyCPU \
            /target:SignAndroidPackage \
            /p:AndroidSigningKeyAlias="PinCountdown" \
            /p:AndroidSigningKeyPass='${{ secrets.KEYSTORE_PASS }}' \
            /p:AndroidSigningStorePass='${{ secrets.KEYSTORE_PASS }}' \
            /p:AndroidKeyStore="true" \
            /p:AndroidSigningKeyStore="$PWD/secrets/PinCountdown.keystore" \
            PinCountdown.Android/PinCountdown.Android.csproj

      - name: Save generated IPA
        uses: actions/upload-artifact@v2
        with:
          name: PinCountdown.iOS.ipa
          path: PinCountdown.iOS/bin/iPhone/Release/PinCountdown.iOS.ipa

      - name: Save generated APK
        uses: actions/upload-artifact@v2
        with:
          name: PinCountdown.Android.apk
          path: PinCountdown.Android/bin/Release/com.messier16.pincountdown-Signed.apk

      - name: Publish to App Store
        run: |
          xcrun altool --upload-app -t ios \
            -f PinCountdown.iOS/bin/iPhone/Release/PinCountdown.iOS.ipa \
            -u "${{ secrets.APPLEID_USERNAME }}" -p "${{ secrets.APPLEID_PASSWORD }}"

      - name: Publish to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_JSON }}
          packageName: com.messier16.pincountdown
          releaseFile: PinCountdown.Android/bin/Release/com.messier16.pincountdown-Signed.apk
          track: alpha
```

Puedes ver todos los cambios que hice en [esta Pull Request](https://github.com/messier16/pin-countdown/pull/1/files).

## Errores comunes y consejos  

He de aceptarlo, poner todas las piezas juntas me cost칩 un poco de trabajo, adem치s de [consumir todos mis minutos disponibles en Actions](https://twitter.com/feregri_no/status/1282370753279725570) porque estaba probando en un repositorio privado. As칤 que con el objetivo de hacer el proceso m치s sencillo para ti te dejo estos consejos:  

 - **Cada que vas a publicar en las tiendas, debes cambiar el n칰mero de versi칩n de tu app**: Las tiendas de aplicaciones son muy estrictas en cuanto a las versiones que publicas de tu app, en el sentido de que no puedes publicar la misma versi칩n dos veces. Te invito a que veas mi post sobre [c칩mo versionar cualquier app con Python](http://feregrino.dev/versioning-any-app-with-python.html) para que veas una manera de hacerlo autom치ticamente.

 - **Aseg칰rate de que el *pipeline*  que publica solamente se ejecute cuando quieres publicar**: si te fijas en el *yaml* anterior, tenemos configurado GitHub actions para que se ejecute cada vez que alguien hace *push* al repo, causando que estemos publicando nuestras apps constantemente; el problema es mayor si ignoramos el punto anterior (cada nueva publicaci칩n en las tiendas requiere una nueva versi칩n). Una soluci칩n para este problema es la de solamente ejecutar este *pipeline* cuando etiquetamos un commit:  

```yaml
on:
  push:
    tags:
      - '*'
```  

  - **Guarda todas las contrase침as que uses**: no podr치s recuperar ninguna contrase침a de las que guardes como secretos de GitHub, es importante que las mantengas a salvo en otro lado en donde si las puedas recuperar.

## 쮻udas?  
Encu칠ntrame en [https://twitter.com/feregri_no](https://twitter.com/feregri_no), en donde con todo gusto responder칠 cualquier duda que tengas.
